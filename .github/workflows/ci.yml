name: Protect Memory Safety (dbeetle - GCC)

on:
    pull_request:
        branches: ["main"]
    push:
        branches: ["main"]

jobs:
    memory-safety:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Install dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y gcc valgrind

            # ---------------------------------
            # Build dbeetle using GCC + Sanitizers
            # ---------------------------------
            - name: Compile dbeetle (ASan + UBSan)
              run: |
                  mkdir -p build
                  gcc \
                    -Wall -Wextra -Wpedantic -Wshadow -Wconversion -Wformat=2 \
                    -std=c11 \
                    -fsanitize=address,undefined \
                    -fno-omit-frame-pointer \
                    src/*.c -I include \
                    -o build/dbeetle

            # ---------------------------------
            # Run under Sanitizers
            # ---------------------------------
            - name: Run with ASan + UBSan
              run: |
                  echo "Running dbeetle with AddressSanitizer + UBSan..."
                  ./build/dbeetle || exit 1

            # ---------------------------------
            # Run under Valgrind (Leak + Bounds Check)
            # ---------------------------------
            - name: Run Valgrind Memory Scan
              run: |
                  echo "Running Valgrind deep scan..."
                  valgrind \
                    --leak-check=full \
                    --show-leak-kinds=all \
                    --track-origins=yes \
                    --errors-for-leak-kinds=all \
                    --error-exitcode=1 \
                    ./build/dbeetle
